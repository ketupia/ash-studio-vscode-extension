# Mermaid Diagrams Feature for Ash Studio VS Code Extension

## Feature Overview

Enable users to view Ash Framework-generated mermaid diagrams (e.g., for policies) directly in VS
Code via a webview. Diagrams are generated by invoking the appropriate Mix task and are stored
outside the user's source tree.

---

## Implementation Plan

### 1. Integrate Diagram Commands with Module Configurations

- Place diagram generation commands in the relevant module configuration files:
  - `Ash.Resource.config.ts`: Commands for generating policy and class diagrams.
  - `Ash.Domain.config.ts`: Command for generating ER diagrams.
- Each config module should export its own command registration and handler logic.
- Import and register these commands in `extension.ts` during activation.
- This keeps diagram features modular and context-aware, and allows for easy extension as Ash
  evolves.
- **Configuration Example:**
  - Update the diagram configuration to an array of objects, each with:
    - `name`: Human-friendly name for the diagram (e.g., "Policy Flowchart", "Class Diagram", "ER
      Diagram").
    - `keyword`: The keyword/section to match (e.g., "policies", "classes").
    - `command`: The Mix command to run (e.g., "ash.generate_policy_charts",
      "ash.generate_resource_diagrams").
    - `filePattern`: The expected diagram file naming pattern, which should account for the format
      (e.g., `.*-policy-flowchart.(mmd|svg|png|pdf)`).
    - `type` (optional): For commands that support a type option (e.g., "class", "entity"), specify
      the type.
  - Example interface addition:
    ```typescript
    export interface DiagramSpec {
      name: string;
      keyword: string;
      command: string;
      filePattern: string;
      type?: string;
    }
    diagrams?: DiagramSpec[];
    ```
  - Example usage:
    ```typescript
    diagrams: [
      {
        name: "Policy Flowchart",
        keyword: "policies",
        command: "ash.generate_policy_charts",
        filePattern: ".*-policy-flowchart.(mmd|svg|png|pdf)",
      },
      {
        name: "Class Diagram",
        keyword: "classes",
        command: "ash.generate_resource_diagrams",
        filePattern: ".*-class-diagram.(mmd|svg|png|pdf)",
        type: "class",
      },
      {
        name: "Entity Resource Diagram",
        keyword: "resources",
        command: "ash.generate_resource_diagrams",
        filePattern: ".*-entity-diagram.(mmd|svg|png|pdf)",
        type: "entity",
      },
    ];
    ```
  - Prefer using `--format plain` to output mermaid code as text, which can be rendered in a webview
    using the mermaid.js CDN (no need to bundle mermaid.js with the extension).
    - In the webview, reference the mermaid.js CDN to render the diagram from the generated mermaid
      code.

### 2. Detect When Diagrams Need to Be Regenerated

- Use a hybrid strategy for diagram generation:
  - Diagrams are generated on demand (when requested or when the webview is opened).
  - Once a diagram has been generated/viewed, keep it current by regenerating on source file save or
    activation, using per-file throttle logic with trailing execution.
  - This approach minimizes disk clutter by only generating diagrams that have been requested, while
    ensuring they remain up to date after first use.
- Regenerate the diagram in these cases:
  - When the relevant resource file is activated (opened/focused) and the diagram is older than the
    file's last modified time, or the diagram does not exist (for diagrams that have been previously
    requested).
  - When the resource file is saved (for diagrams that have been previously requested).
  - A command and CodeLens should trigger the diagram generation (if needed) and display the diagram
    in a webview.

### 3. Store Diagrams in the Project

- Diagrams will be detected and used from their default location in the resource directory. the mix
  tasks don't have an option for specifying the output folder.

### 4. Provide Commands and CodeLens for Viewing Diagrams

- Add a command (e.g., `ash-studio.showPolicyDiagram`) to the command palette and/or context menu
  for resource files.
- Implement a CodeLens above relevant sections (e.g., policies, classes) in resource files to allow
  users to view the diagram directly from the editor.
- **Separation of Concerns:**
  - **Show:**
    - Watch for creation/updates of diagram files in the expected location and naming pattern.
    - Offer to display diagrams in the webview whenever they exist, regardless of how they were
      generated.
  - **Generate:**
    - On source file activation or save, trigger diagram generation using the Mix task.

### 5. Documentation and Git Ignore Recommendations

- Update the README to clearly document:
  - Diagrams are created on demand—only when requested or viewed—minimizing disk clutter and keeping
    the source directory cleaner.
  - The throttle logic for diagram generation is implemented per source file, with trailing
    execution: diagrams are generated immediately on the first event, and again at the end of the
    interval if additional events occurred during the wait. This ensures no changes are missed
    during rapid saves or activations.
- recommend to users add entries to their `.gitignore` to prevent diagram output files from being
  committed to version control. Example entries:
  ```gitignore
  lib/**/*.mmd
  lib/**/*.svg
  lib/**/*.png
  lib/**/*.pdf
  lib/**/*.md
  ```
- Provide these recommendations in the README and as a notification or tip in the extension when
  enabling diagram generation.

### 6. Welcome Script and Onboarding on First Use

- Implement a welcome script that runs on first activation of the extension:
  - Prompt the user to enable Automatic Diagram Generation (`ash-studio.enableDiagrams`).
    - Use a notification with action buttons (e.g., "Enable", "Not Now").
    - If the user chooses "Enable", update the setting or guide them to the settings UI.
  - Offer to add recommended `.gitignore` entries for diagram output formats (if the workspace
    contains a `.gitignore` and it is safe to update):
    - Entries to add:
      ```gitignore
      lib/**/*.mmd
      lib/**/*.svg
      lib/**/*.png
      lib/**/*.pdf
      lib/**/*.md
      ```
    - If possible, append these entries to the workspace `.gitignore` file after user confirmation.
  - Show a link to the README for further configuration and documentation.

---

## Implementation Checklist: On-Demand Mermaid Diagram Generation

1. **Module Configuration**
   - [x] Update each relevant config module (e.g., `Ash.Resource.config.ts`, `Ash.Domain.config.ts`)
         to export diagram command specs as described.
   - [x] Add the following interface for diagram specs:
     ```typescript
     export interface DiagramSpec {
       name: string;
       keyword: string;
       command: string;
       filePattern: string;
       type?: string;
     }
     diagrams?: DiagramSpec[];
     ```
   - [x] Example usage:
     ```typescript
     diagrams: [
       {
         name: "Policy Flowchart",
         keyword: "policies",
         command: "ash.generate_policy_charts",
         filePattern: ".*-policy-flowchart.(mmd|svg|png|pdf)",
       },
       {
         name: "Class Diagram",
         keyword: "classes",
         command: "ash.generate_resource_diagrams",
         filePattern: ".*-class-diagram.(mmd|svg|png|pdf)",
         type: "class",
       },
       {
         name: "Entity Resource Diagram",
         keyword: "resources",
         command: "ash.generate_resource_diagrams",
         filePattern: ".*-entity-diagram.(mmd|svg|png|pdf)",
         type: "entity",
       },
     ];
     ```
   - [x] Ensure each diagram spec includes name, keyword, command, filePattern, and optional type.
   2. **Extension Settings: Diagram Format**
   - [x] Add an extension setting (e.g., `ash-studio.diagramFormat`) to allow users to choose the
         diagram output format.
   - [x] Supported values: `plain` (default, mermaid text), `md` (markdown code block), `svg`,
         `pdf`, `png`.
   - [x] Use the selected format when invoking Mix tasks for diagram generation.
   - [ ] Document the setting and its options in the README and onboarding flow.
   - [ ] Add unit tests to ensure the setting is respected and passed to Mix commands.

2. **Diagram Generation Utilities**

- [x] Implement a function to invoke the appropriate Mix task for diagram generation, given a
      DiagramSpec and resource file path.
- [x] Implement a function to check if a diagram file already exists and is current, given a
      DiagramSpec and resource file path.
- [ ] Add unit tests for both functions to ensure correct Mix invocation and file existence/age
      checking.

4. **Command Registration**
   - [ ] Import and register diagram commands in `extension.ts` during activation.
   - [ ] Add command palette and context menu entries for viewing diagrams.

5. **On-Demand Generation Logic**
   - [ ] Implement logic to generate diagrams only when requested (webview opened or command
         triggered).
   - [ ] Check if diagram exists and is current before generating; otherwise, run Mix task to
         generate.

6. **Throttle Logic (Per File, Trailing Execution)**
   - [ ] After a diagram has been generated/viewed, set up per-file throttle logic to keep it
         current on save/activation.
   - [ ] Ensure trailing execution: generate immediately on first event, and again at the end of the
         interval if additional events occur.

7. **Webview Integration**
   - [x] Render mermaid diagrams in a webview using the mermaid.js CDN.
   - [ ] Handle loading state if diagram generation is in progress.

8. **CodeLens and UI Integration**
   - [ ] Add CodeLens above relevant sections to trigger diagram generation/viewing.
   - [ ] Ensure UI elements only appear for diagrams that have been requested/viewed.

9. **.gitignore Recommendations**
   - [ ] Provide notification/tip to add diagram output files to `.gitignore`.
   - [ ] Optionally, offer to append recommended entries to `.gitignore` after user confirmation.

10. **Welcome Script and Onboarding**

- [ ] Remove or update any references to 'automatically generate' setting.
- [ ] Implement onboarding flow to explain on-demand generation and .gitignore recommendations.

11. **Documentation**

- [ ] Update README to reflect on-demand generation, throttle logic, and .gitignore advice.
- [ ] Document UI/command usage and configuration options.

12. **Testing and Manual Validation**
    - [ ] Manually test diagram generation, viewing, and update logic in Extension Development Host.
    - [ ] Validate that diagrams are only generated on demand and kept current after first use.
    - [ ] Confirm .gitignore recommendations and onboarding flow work as intended.

---

## Summary

- Store generated diagrams in a dedicated `diagrams/` folder in extension storage, organized by
  project and mirroring the source code structure.
- Detect when diagrams need to be regenerated based on file activation, save, or manual refresh.
- Provide a command to clear the diagram cache for the current project via the command palette.
- Integrate diagram generation commands with the appropriate module configuration files for
  modularity and context-awareness.
- Provide commands and CodeLens for viewing diagrams, triggering diagram generation and display in a
  webview.
- Future enhancements can add duration-based cleanup and more UI options.
