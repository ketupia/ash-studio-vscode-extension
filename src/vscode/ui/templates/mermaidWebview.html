<!doctype html>
<html>
  <head>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; img-src {{CSP_SOURCE}} data:; style-src 'unsafe-inline' {{CSP_SOURCE}}; script-src 'unsafe-inline' {{CSP_SOURCE}};"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/@mermaid-js/tiny@11/dist/mermaid.tiny.js"
      defer
    ></script>
    <!-- <script
      src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"
      defer
    ></script> -->
    <script
      src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"
      defer
    ></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        box-sizing: border-box;
      }
      .mermaid {
        background-color: #a8b0d4;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        display: block;
        overflow: hidden;
        position: relative;
        margin: 0;
      }
      .mermaid > svg {
        display: block;
        width: 100%;
        height: 100%;
        max-width: 100% !important;
      }
      .controls {
        position: absolute;
        bottom: 5px;
        right: 10px;
      }
    </style>
  </head>
  <body>
    <pre id="mermaidDiv" class="mermaid">{{MERMAID_CODE}}</pre>
    <div class="controls">
      <button id="zoom-in">Zoom in</button>
      <button id="zoom-out">Zoom out</button>
      <button id="reset">Reset</button>
    </div>
    <script>
      (function () {
        const MERMAID_SELECTOR = ".mermaid";
        const SVG_SELECTOR = ".mermaid svg";
        const MIN_ZOOM_LEVEL = 0.1;
        const MAX_ZOOM_LEVEL = 10;
        let attempts = 0;

        function showError(message, err) {
          try {
            console.error("[AshStudio]", message, err);

            const el = document.getElementById("mermaidDiv");
            const details =
              err && err.message ? err.message : err ? String(err) : "";
            const text = details ? `${message} ${details}` : message;
            if (el) {
              // use textContent to avoid injecting HTML
              el.textContent = text;
              // make the error visible and styled
              if (el.style) {
                el.style.background = "#fff3f3";
                el.style.color = "#900";
                el.style.padding = "12px";
                el.style.borderRadius = "6px";
              }
            }
          } catch (e) {
            // fallback to console if DOM update fails
            console.error("[AshStudio] showError failed", e);
          }
        }

        async function renderMermaid() {
          window.mermaid.initialize({ startOnLoad: false });
          await window.mermaid.run({
            querySelector: MERMAID_SELECTOR,
          });
        }

        function ensureSvgViewBox(svg) {
          if (!svg.getAttribute("viewBox")) {
            try {
              const bbox = svg.getBBox();
              svg.setAttribute(
                "viewBox",
                `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`
              );
            } catch (e) {
              /* getBBox can fail on some SVGs, guard it */
            }
          }
          svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
        }

        function registerControlListeners(pz) {
          document
            .getElementById("zoom-in")
            .addEventListener("click", function (ev) {
              ev.preventDefault();

              pz.zoomIn();
            });

          document
            .getElementById("zoom-out")
            .addEventListener("click", function (ev) {
              ev.preventDefault();

              pz.zoomOut();
            });

          document
            .getElementById("reset")
            .addEventListener("click", function (ev) {
              ev.preventDefault();

              pz.resetZoom();
              pz.resize();
              pz.fit();
              pz.center();
            });
        }

        function initPanZoom() {
          const svg = document.querySelector(SVG_SELECTOR);
          if (!svg) {
            showError("[AshStudio] no svg:");
            return;
          }

          ensureSvgViewBox(svg);

          const pz = window.svgPanZoom(svg, {
            zoomEnabled: true,
            controlIconsEnabled: false,
            fit: true,
            center: true,
            minZoom: MIN_ZOOM_LEVEL,
            maxZoom: MAX_ZOOM_LEVEL,
          });

          registerControlListeners(pz);

          pz.resize();
          pz.fit();
          pz.center();

          window.addEventListener("resize", () => {
            try {
              pz.resize();
              pz.fit();
              pz.center();
            } catch (err) {
              console.debug(
                "[AshStudio] svgPanZoom resize handling issue:",
                err
              );
            }
          });
        }

        function onReady() {
          if (!window.mermaid) {
            showError("Mermaid library failed to load.");
            return;
          }
          if (!window.svgPanZoom) {
            showError("svg-pan-zoom library failed to load.");
            return;
          }
          renderMermaid()
            .then(() => initPanZoom())
            .catch(err => showError("render/init failed", err));
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", onReady, {
            once: true,
          });
        } else {
          onReady();
        }
      })();
    </script>
  </body>
</html>
